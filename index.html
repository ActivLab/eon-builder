<!DOCTYPE html>
<html>
<head>
  <style type="text/css">
  #chart-wrapper {
    position: fixed;
  }
  #chart {
    height: 300px;
    width: 350px;
  }
  .container-fluid {
    width: 90%;
    margin-left: 5%;
    margin-right: 5%;
  }
  </style>

</head>
<body>
 
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-9">

        <div class="form-group">
          <label>Subscribe Key</label>
          <p class="text-muted">The PubNub subscribe key.</p>
          <input type="text" class="form-control" id="subscribe-key" value="demo">
        </div>

        <div class="form-group">
          <label>Channel</label>
          <p class="text-muted">The PubNub channel where your data is being published.</p>
          <input type="text" class="form-control" id="channel" value="eon-builder">
        </div>

        <label>Data</label>
        <p class="text-muted">Click on a row to start seeing it output to the chart. Note that only integer values are shown here.</p>

        <div class="form-group">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Label</th>
              <th>Value</th>
              <th>Color</th>
              <th>Graph</th>
            </tr>
          </thead>
          <tbody id="kvs">
          </tbody>
        </table>
        </div>

        <div class="form-group">
          <label>Chart Type</label>
          <p class="text-muted">Time series, bar, donut, your call.</p>
          <select class="form-control" id="chart-type">
            <option value="spline">Spline</option>
            <option value="area">Area</option>
            <option value="area-spline">Area Spline</option>
            <option value="step">Step</option>
            <option value="area-step">Area Step</option>
            <option value="scatter">Scatter</option>
            <option value="bar">Bar</option>
            <option value="donut">Donut</option>
            <option value="pie">Pie</option>
          </select>
        </div>

        <div class="form-group">
          <label>X Axis Label</label>
          <input type="text" class="form-control" id="xlabel" value="">
        </div>

        <div class="form-group">
          <label>Y Axis Label</label>
          <input type="text" class="form-control" id="ylabel" value="">
        </div>

        <div class="form-group">
          <label>Update Rate (ms)</label>
          <p class="text-muted">How fast your chart will update. If data is published faster than the update rate, it will be overwritten. If the chart updates before new data is received, data will remain stagnant.</p>
          <input type="text" class="form-control" id="rate" value="1000">
        </div>

        <div class="form-group">
          <label>Animation (ms)</label>
          <p class="text-muted">How long each animation will last.</p>
          <input type="text" class="form-control" id="duration" value="250">
        </div>

        <div class="form-group">
          <label>Limit</label>
          <p class="text-muted">How many data points to display.</p>
          <input type="text" class="form-control" id="limit" value="5">
        </div>

        <div class="form-group">
          <input type="checkbox" id="history" checked>  <label>History</label>
          <p class="text-muted">Use PubNub history to populate the chart on load</p>
        </div>

      </div>
      <div class="col-md-3">
        <div id="chart-wrapper">
         
          <button type="submit" class="btn btn-default" id="submit">Update</button>
          <button type="submit" class="btn btn-default" id="change">Swap</button>
          
          <div id="chart"></div>
          <textarea id="embed" class="form-control" style="height: 500px"></textarea>

        </div>
      </div>
    </div>
  </div> 
  
  <script type="text/javascript" src="http://pubnub.github.io/eon/lib/eon.js"></script>
  <link type="text/css" rel="stylesheet" href="http://pubnub.github.io/eon/lib/eon.css" />

  <script type="text/javascript" src="./bower_components/jquery/dist/jquery.min.js"></script>
  <script type="text/javascript" src="./bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <link rel="stylesheet" type="text/css" href="./bower_components/bootstrap/dist/css/bootstrap.min.css">

  <link rel="stylesheet" type="text/css" href="./bower_components/mjolnic-bootstrap-colorpicker/dist/css/bootstrap-colorpicker.min.css">
  <script type="text/javascript" src="./bower_components/mjolnic-bootstrap-colorpicker/dist/js/bootstrap-colorpicker.min.js"></script>

  <link href="./bower_components/bootstrap-toggle/css/bootstrap-toggle.min.css" rel="stylesheet">
  <script src="./bower_components/bootstrap-toggle/js/bootstrap-toggle.min.js"></script>

  <script src="./bower_components/x-editable/dist/bootstrap3-editable/js/bootstrap-editable.min.js"></script>
  <link href="./bower_components/x-editable/dist/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet">

  <script type="text/javascript">

  function isNumber(n) {
    return !isNaN(parseFloat(n)) && isFinite(n);
  }

  var defaultColors = [
    '#113F8C',
    '#01A4A4',
    '#00A1CB',
    '#61AE24',
    '#D0D102',
    '#32742C',
    '#D70060',
    '#E54028',
    '#F18D05'
  ];

  var input = {
    type: function() { return $('#chart-type').val() },
    channel: function() { return $('#channel').val() },
    subscribe_key: function() { return $('#subscribe-key').val() },
    rate: function() { return $('#rate').val() },
    duration: function() { return $('#duration').val() },
    limit: function() { return $('#limit').val() },
    history: function() { return $('#history').is(':checked') || false },
    xlabel: function() { return $('#xlabel').val() },
    ylabel: function() { return $('#ylabel').val() }
  };

  var builder = function() {
    
    console.log('builder started')

    var self = this;
 
    self.cols = [];
    self.labels = {};
    self.colors = {};

    self.refresh = function() {

      console.log(self.colors)

      self.type = input.type();
      self.channel = input.channel();
      self.subscribe_key = input.subscribe_key();
      self.rate = input.rate();
      self.duration = input.duration();
      self.limit = input.limit();
      self.history = input.history();
      self.xlabel = input.xlabel();
      self.ylabel = input.ylabel();

      self.flow = false;

      if(self.type == "spline" ||
        self.type == "area" ||
        self.type == "area-spline" ||
        self.type == "step" ||
        self.type == "area-step" ||
        self.type == "scatter") {

        self.flow = true;

      }

      self.chart = eon.chart({
        pubnub: self.pubnub,
        channel: self.channel,
        history: self.history,
        flow: self.flow,
        rate: self.rate,
        limit: self.limit,
        generate: {
          bindto: '#chart',
          data: {
            type: self.type,
            colors: self.colors
          },
          transition: {
            duration: self.duration
          },
          axis: {
            x: {
              label: self.xlabel
            },
            y: {
              label: self.ylabel
            }
          }
        },
        transform: function(message) {

          var message = eon.c.flatten(message);

          var array = self.cols.map(function(arg){
            return [self.labels[arg] || arg, message[arg]];
          });

          return {
            columns: array
          };

        }
      });

      self.pedit.subscribe({
        channel: self.channel,
        message: function(data) {

          var data = eon.c.flatten(data);

          for(var key in data) {

            var $row = $('[data-key="' + key + '"]');
            var value = data[key];

            if(!isNaN(value)) {

              if($row.length) {

                $row.find('.val').text(value)

              } else {

                self.cols.push(key);

                var color = defaultColors[$('tr').length % defaultColors.length];

                var $row = $('\
                  <tr data-key="' + key + '"> \
                    <td class="key"><a href="#" id="key-edit" data-type="text" data-title="Enter new key.">' + key + '</a></td> \
                    <td class="val">' + value + '</td> \
                    <td> \
                      <div class="input-group colorpick" data-key="' + key + '"> \
                          <input type="text" value="' + color + '" class="form-control" /> \
                          <span class="input-group-addon"><i></i></span> \
                      </div> \
                    </td> \
                    <td> \
                    <input type="checkbox" class="toggle" checked data-toggle="toggle"> \
                    </td> \
                  </tr>');

                var picker = $row.find('.colorpick').colorpicker();

                self.colors[key] = color;
                picker.on('changeColor.colorpicker', function(event){
                  
                  self.colors[$(this).closest('tr').attr('data-key')] = event.color.toHex();

                });

                $row.find('#key-edit').editable({
                    send: 'never',
                    unsavedclass: null,
                    success: function(response, newValue) {
                      
                      $(this).removeClass('editable-unsaved');
                      
                      var thisKey = $(this).closest('tr').attr('data-key');
                      
                      self.labels[thisKey] = newValue;

                      // colors map to displayed keys in c3
                      self.colors[newValue] = self.colors[thisKey];
                      delete self.colors[thisKey];

                      self.refresh();
                      
                    }
                });

                $row.find('.toggle').bootstrapToggle('on');

                $row.find('.toggle').change(function() {
                  
                  var thisKey = $(this).closest('tr').attr('data-key');
                  var isChecked = $(this).prop('checked');

                  if(typeof (isChecked) !== "undefined") {

                    if(isChecked){

                      self.cols.push(thisKey);
                      self.embed();

                    } else {

                      for(var i in self.cols) {

                        if(self.cols[i] == thisKey) {
                          self.cols.splice(i, 1);
                          self.refresh();
                        }

                      }
                       
                    }
                     
                  }

                })

                $('#kvs').append($row);
                self.embed();

              }

            }

          }

        }
      });

    }

    self.unload = function() {
      
      self.pedit.unsubscribe({
        channel: self.channel
      });

      self.pubnub.unsubscribe({
        channel: self.channel
      });

      $('#kvs').empty();

    }
      
    self.pubnub = PUBNUB.init({
      subscribe_key: self.subscribe_key
    });

    self.pedit = PUBNUB.init({
      subscribe_key: self.subscribe_key
    });

    self.refresh();

    self.embed = function() {

      var embedsrc = '' +
        '<script type="text/javascript" src="http://pubnub.github.io/eon/lib/eon.js"><\/script>\n' +
        '<link type="text/css" rel="stylesheet" href="http://pubnub.github.io/eon/lib/eon.css" />\n' +
        '<div id="chart"></div>\n' + 
        '<script type="text/javascript">\n' +
        'var pubnub = PUBNUB.init({\n' +
        '  subscribe_key: "' + self.subscribe_key + '"\n' +
        '});\n' +
        'var cols = ' + '["' + self.cols.join('","') + '"];' + '\n' +
        'chart = eon.chart({\n' +
        '  pubnub: pubnub,\n' +
        '  channel: "' + self.channel + '",\n' +
        '  history: ' + self.history + ',\n' +
        '  flow: ' + self.flow +',\n' +
        '  rate: ' + self.rate + ',\n' +
        '  limit: ' + self.limit + ',\n' +
        '  generate: {\n' +
        '    bindto: "#chart",\n' +
        '    data: {\n' +
        '      colors: ' + JSON.stringify(self.colors) + ',\n' + 
        '      type: "' + self.type + '"\n' +
        '    },\n' +
        '    transition: {\n' +
        '      duration: ' + self.duration + '\n' +
        '    },\n' +
        '    axis: {\n' +
        '      x: {\n' +
        '        label: "' + self.xlabel + '"\n' +
        '      },\n' +
        '      y: {\n' +
        '        label: "' + self.ylabel + '"\n' +
        '      }\n' +
        '    }\n' +
        '  },\n' +
        '  transform: function(message) {\n' +
        '    var message = eon.c.flatten(message);\n' + 
        '    var array = cols.map(function(arg){\n' +
        '      return [arg, message[arg]];\n' +
        '    });\n' +
        '    return {\n' + 
        '      columns: array\n' +
        '    };\n' +
        '  }\n' + 
        '});\n' +
        '<\/script>';

      $('#embed').val(embedsrc)

    };

    return self;

  };

  // sub-c-5f1b7c8e-fbee-11e3-aa40-02ee2ddab7fe
  // pubnub-sensor-network

  var b = new builder();

  var init = function() {
  
    // restart if they change subscribe or channel
    if(input.subscribe_key() !== b.subscribe_key ||
       input.channel() !== b.channel) {
      b.unload();
      delete b;
      b = new builder();
    } else {
      b.refresh();
    }    
  }

  $('#submit').click(function(e) {
    init();
    return false;
  });

  $('#change').click(function(){

    $('#subscribe-key').val('demo')
    $('#channel').val('eon-builder22');

    init();

    return false;
  });

  $('#chart-type').change(function(e) {
    b.refresh();
  });

  var pubnub3 = PUBNUB.init({
    subscribe_key: 'demo'
  });

  setInterval(function(){
    pubnub3.publish({
      channel: 'eon-builder',
      message: {
        something: 1,
        something_else: {
          another_thing: {
            value: Math.random() * 100
          }
        },
        a: Math.random() * 100,
        b: Math.random() * 100,
        c: Math.random() * 100,
      }
    });
  }, 1000);

  setInterval(function(){
    pubnub3.publish({
      channel: 'eon-builder22',
      message: {
        something: 1,
        something_else: {
          another_thing: {
            value: Math.random() * 100
          }
        },
        a: Math.random() * 100,
        b: Math.random() * 100,
        c: Math.random() * 100,
        a2: Math.random() * 100,
        b2: Math.random() * 100,
        c2: Math.random() * 100,
        a3: Math.random() * 100,
        b3: Math.random() * 100,
        c3: Math.random() * 100,
        a4: Math.random() * 100,
        b4: Math.random() * 100,
        c4: Math.random() * 100,
        a5: Math.random() * 100,
        b5: Math.random() * 100,
        c5: Math.random() * 100
      }
    });
  }, 1000)

  </script>

</body>
</html>