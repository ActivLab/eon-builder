<!DOCTYPE html>
<html>
<head>
  <style type="text/css">
  #chart-wrapper {
    position: fixed;
  }
  #chart {
    height: 300px;
    width: 350px;
  }
  .container-fluid {
    width: 90%;
    margin-left: 5%;
    margin-right: 5%;
  }
  </style>

</head>
<body>
 
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-9">

        <h2>Chart</h2>
        <p class="text-muted">Configure your realtime chart.</p>

        <div class="form-group">
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th class="col-md-3">Attribute</th>
                <th class="col-md-3">Value</th>
                <th class="col-md-6">Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Subscribe Key</td>
                <td>
                  <a href="#" id="subscribe_key" data-type="text" data-title="Enter new subscribe key." class="subscribe_key"></a> 
                </td>
                <td>
                  <p class="text-muted">The PubNub subscribe key.</p>
                </td>
              </tr>
              <tr>
                <td>Channel</td>
                <td>
                  <a href="#" id="channel" data-type="text" data-title="Enter new PubNub channel." class="channel"></a> 
                </td>
                <td>
                  <p class="text-muted">The PubNub channel where your data is being published.</p>
                </td>
              </tr>
              <tr>
                <td>Chart Type</td>
                <td>
                  <a href="#" id="type" data-type="select" data-title="Choose a chart type.">spline</a> 
                </td>
                <td>
                  <p class="text-muted">Time series, bar, donut, your call.</p></td>
              </tr>
              <tr>
                <td>X Axis Label</td>
                <td>
                  <a href="#" id="xlabel" data-type="text" data-title="Enter new X Axis Label"></a> 
                </td>
                <td></td>
              </tr>
              <tr>
                <td>Y Axis Label</td>
                <td>
                  <a href="#" id="ylabel" data-type="text" data-title="Enter new Y Axis Label"></a> 
                </td>
                <td></td>
              </tr>
              <tr>
                <td>Animation</td>
                <td>
                  <a href="#" id="duration" data-type="text" data-title="Enter new animation length (ms)">250</a> 
                </td>
                <td><p class="text-muted">How long each animation will last.</p></td>
              </tr>
              <tr>
                <td>Limit</td>
                <td>
                  <a href="#" id="limit" data-type="text" data-title="Enter new limit">5</a> 
                </td>
                <td><p class="text-muted">How many data points to display.</p></td>
              </tr>
              <tr>
                <td>Enable History</td>
                <td>
                  <input type="checkbox" id="history" checked>  Enable
                </td>
                <td><p class="text-muted">Use PubNub history to populate the chart on load</p></td>
              </tr>
              <tr>
                <td>Update Rate (ms)</td>
                <td>
                  <a href="#" id="rate" data-type="text" data-title="Enter new update rate in milliseconds.">1000</a> 
                </td>
                <td><p class="text-muted">How fast your chart will update. If data is published faster than the update rate, it will be overwritten. If the chart updates before new data is received, data will remain stagnant.</p></td>
              </tr>
            </tbody>
          </table>
        </div>

        <h2>Data</h2>
        <p class="text-muted">Click on a row to start seeing it output to the chart. Note that only integer values are shown here.</p>

        <div class="form-group">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Label</th>
              <th>Value</th>
              <th>Color</th>
              <th>Graph</th>
            </tr>
          </thead>
          <tbody id="kvs">
          </tbody>
        </table>
        </div>

      </div>
      <div class="col-md-3">
        <div id="chart-wrapper">
         
          <button type="submit" class="btn btn-default" id="submit">Update</button>
          <button type="submit" class="btn btn-default" id="change">Swap</button>
          
          <div id="chart"></div>
          <textarea id="embed" class="form-control" style="height: 500px"></textarea>

        </div>
      </div>
    </div>
  </div> 
  
  <script type="text/javascript" src="http://pubnub.github.io/eon/lib/eon.js"></script>
  <link type="text/css" rel="stylesheet" href="http://pubnub.github.io/eon/lib/eon.css" />

  <script type="text/javascript" src="./bower_components/jquery/dist/jquery.min.js"></script>
  <script type="text/javascript" src="./bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <link rel="stylesheet" type="text/css" href="./bower_components/bootstrap/dist/css/bootstrap.min.css">

  <link rel="stylesheet" type="text/css" href="./bower_components/mjolnic-bootstrap-colorpicker/dist/css/bootstrap-colorpicker.min.css">
  <script type="text/javascript" src="./bower_components/mjolnic-bootstrap-colorpicker/dist/js/bootstrap-colorpicker.min.js"></script>

  <link href="./bower_components/bootstrap-toggle/css/bootstrap-toggle.min.css" rel="stylesheet">
  <script src="./bower_components/bootstrap-toggle/js/bootstrap-toggle.min.js"></script>

  <script src="./bower_components/x-editable/dist/bootstrap3-editable/js/bootstrap-editable.min.js"></script>
  <link href="./bower_components/x-editable/dist/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet">

  <script type="text/javascript">

  function updateQueryStringParameter(uri, key, value) {
    var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
    var separator = uri.indexOf('?') !== -1 ? "&" : "?";
    if (uri.match(re)) {
      return uri.replace(re, '$1' + key + "=" + value + '$2');
    }
    else {
      return uri + separator + key + "=" + value;
    }
  }
  
  var QueryString = function () {
    // This function is anonymous, is executed immediately and 
    // the return value is assigned to QueryString!
    var query_string = {};
    var query = window.location.search.substring(1);
    var vars = query.split("&");
    for (var i=0;i<vars.length;i++) {
      var pair = vars[i].split("=");
          // If first entry with this name
      if (typeof query_string[pair[0]] === "undefined") {
        query_string[pair[0]] = decodeURIComponent(pair[1]);
          // If second entry with this name
      } else if (typeof query_string[pair[0]] === "string") {
        var arr = [ query_string[pair[0]],decodeURIComponent(pair[1]) ];
        query_string[pair[0]] = arr;
          // If third or later entry with this name
      } else {
        query_string[pair[0]].push(decodeURIComponent(pair[1]));
      }
    } 
      return query_string;
  }();

  function isNumber(n) {
    return !isNaN(parseFloat(n)) && isFinite(n);
  }

  var defaultColors = [
    '#113F8C',
    '#01A4A4',
    '#00A1CB',
    '#61AE24',
    '#D0D102',
    '#32742C',
    '#D70060',
    '#E54028',
    '#F18D05'
  ];

  var channel = QueryString.channel || 'eon-builder';
  var subscribe_key = QueryString.subscribe_key || 'demo';

  var builder = function(params) {
    
    console.log('builder started', params)

    var self = this;
 
    self.cols = [];
    self.labels = {};
    self.colors = {};

    self.refresh = function(params) {

      var params = params || {};

      console.log('refresh with ' , params)

      self.type = params.type || self.type || 'spline';

      self.rate = params.rate || self.rate || false;
      self.duration = params.duration || self.duration || 250;
      self.limit = params.limit || self.limit || 5;
      self.xlabel = params.xlabel || self.xlabel || false;
      self.ylabel = params.ylabel || self.ylabel || false;

      if(typeof self.history == "undefined") {
        self.history = true;
      }

      if(typeof params.history !== "undefined") {
        self.history = params.history;
      }

      self.flow = false;

      if(self.type == "spline" ||
        self.type == "area" ||
        self.type == "area-spline" ||
        self.type == "step" ||
        self.type == "area-step" ||
        self.type == "scatter") {

        self.flow = true;

      }

      self.chart = eon.chart({
        pubnub: self.pubnub,
        channel: channel,
        history: self.history,
        flow: self.flow,
        rate: self.rate,
        limit: self.limit,
        generate: {
          bindto: '#chart',
          data: {
            type: self.type,
            colors: self.colors
          },
          transition: {
            duration: self.duration
          },
          axis: {
            x: {
              label: self.xlabel
            },
            y: {
              label: self.ylabel
            }
          }
        },
        transform: function(message) {

          var message = eon.c.flatten(message);

          var array = self.cols.map(function(arg){
            return [self.labels[arg] || arg, message[arg]];
          });

          return {
            columns: array
          };

        }
      });

      self.pedit.subscribe({
        channel: channel,
        message: function(data, a, b) {

          console.log(data, a ,b)

          var data = eon.c.flatten(data);

          for(var key in data) {

            var $row = $('[data-key="' + key + '"]');
            var value = data[key];

            if(!isNaN(value)) {

              if($row.length) {

                $row.find('.val').text(value)

              } else {

                self.cols.push(key);

                var color = defaultColors[$('tr').length % defaultColors.length];

                var $row = $('\
                  <tr data-key="' + key + '"> \
                    <td class="key"><a href="#" id="key-edit" data-type="text" data-title="Enter new key.">' + key + '</a></td> \
                    <td class="val">' + value + '</td> \
                    <td> \
                      <dciv class="input-group colorpick" data-key="' + key + '"> \
                          <input type="text" value="' + color + '" class="form-control" /> \
                          <span class="input-group-addon"><i></i></span> \
                      </div> \
                    </td> \
                    <td> \
                    <input type="checkbox" class="toggle" checked data-toggle="toggle"> \
                    </td> \
                  </tr>');

                var picker = $row.find('.colorpick').colorpicker();

                self.colors[key] = color;
                picker.on('changeColor.colorpicker', function(event){
                  
                  self.colors[$(this).closest('tr').attr('data-key')] = event.color.toHex();

                });

                $row.find('#key-edit').editable({
                    unsavedclass: null,
                    success: function(response, newValue) {
                      
                      var thisKey = $(this).closest('tr').attr('data-key');
                      
                      self.labels[thisKey] = newValue;

                      // colors map to displayed keys in c3
                      self.colors[newValue] = self.colors[thisKey];
                      delete self.colors[thisKey];

                      self.refresh();

                    }
                });

                $row.find('.toggle').bootstrapToggle('on');

                $row.find('.toggle').change(function() {
                  
                  var thisKey = $(this).closest('tr').attr('data-key');
                  var isChecked = $(this).prop('checked');

                  if(typeof (isChecked) !== "undefined") {

                    if(isChecked){

                      self.cols.push(thisKey);
                      self.embed();

                    } else {

                      for(var i in self.cols) {

                        if(self.cols[i] == thisKey) {
                          self.cols.splice(i, 1);
                          self.refresh();
                        }

                      }
                       
                    }
                     
                  }

                })

                $('#kvs').append($row);
                self.embed();

              }

            }

          }

        }
      });

      self.embed();

    }

    self.embed = function() {

      var embedsrc = '' +
        '<script type="text/javascript" src="http://pubnub.github.io/eon/lib/eon.js"><\/script>\n' +
        '<link type="text/css" rel="stylesheet" href="http://pubnub.github.io/eon/lib/eon.css" />\n' +
        '<div id="chart"></div>\n' + 
        '<script type="text/javascript">\n' +
        'var pubnub = PUBNUB.init({\n' +
        '  subscribe_key: "' + subscribe_key + '"\n' +
        '});\n' +
        'var cols = ' + '["' + self.cols.join('","') + '"];' + '\n' +
        'chart = eon.chart({\n' +
        '  pubnub: pubnub,\n' +
        '  channel: "' + channel + '",\n' +
        '  history: ' + self.history + ',\n' +
        '  flow: ' + self.flow +',\n' +
        '  rate: ' + self.rate + ',\n' +
        '  limit: ' + self.limit + ',\n' +
        '  generate: {\n' +
        '    bindto: "#chart",\n' +
        '    data: {\n' +
        '      colors: ' + JSON.stringify(self.colors) + ',\n' + 
        '      type: "' + self.type + '"\n' +
        '    },\n' +
        '    transition: {\n' +
        '      duration: ' + self.duration + '\n' +
        '    },\n' +
        '    axis: {\n' +
        '      x: {\n' +
        '        label: "' + self.xlabel + '"\n' +
        '      },\n' +
        '      y: {\n' +
        '        label: "' + self.ylabel + '"\n' +
        '      }\n' +
        '    }\n' +
        '  },\n' +
        '  transform: function(message) {\n' +
        '    var message = eon.c.flatten(message);\n' + 
        '    var array = cols.map(function(arg){\n' +
        '      return [arg, message[arg]];\n' +
        '    });\n' +
        '    return {\n' + 
        '      columns: array\n' +
        '    };\n' +
        '  }\n' + 
        '});\n' +
        '<\/script>';

      $('#embed').val(embedsrc)

    };

    console.log(self.subscribe_key)

    self.pubnub = PUBNUB.init({
      subscribe_key: subscribe_key
    });

    self.pedit = PUBNUB.init({
      subscribe_key: subscribe_key
    });

    self.refresh(params);

    return self;

  };

  // sub-c-5f1b7c8e-fbee-11e3-aa40-02ee2ddab7fe
  // pubnub-sensor-network

  /*
  chart is not unsubscribing when destoryed, values still show up
  */
  var b;

  var reboot = function(params) {
    b.unload();    
    delete b;
    b = new builder(params);
  }

  $('.channel').text(channel);
  $('.subscribe_key').text(subscribe_key);

  $('#subscribe_key').editable({
    unsavedclass: null,
    success: function(r, newValue) {
      var a = updateQueryStringParameter(window.location.href, 'subscribe_key', newValue)
      window.location = a;
    }
  });

  $('#channel').editable({
    unsavedclass: null,
    success: function(r, newValue){
      var a = updateQueryStringParameter(window.location.href, 'channel', newValue)
      window.location = a;
    }
  })

  $('#rate').editable({
    unsavedclass: null,
    success: function(r, newValue) {
      b.refresh({rate: newValue});
    }
  });

  $('#duration').editable({
    unsavedclass: null,
    success: function(r, newValue) {
      b.refresh({duration: newValue});
    }
  });
  
  $('#limit').editable({
    unsavedclass: null,
    success: function(r, newValue) {
      b.refresh({limit: newValue});
    }
  });
  
  $('#history').click(function(){
    b.refresh({history: $(this).is(':checked') });
  });
  
  $('#xlabel').editable({
    unsavedclass: null,
    success: function(r, newValue) {
      b.refresh({xlabel: newValue});
    }
  });
  
  $('#ylabel').editable({
    unsavedclass: null,
    success: function(r, newValue) {
      b.refresh({
        ylabel: newValue
      });
    }
  });

  $('#type').editable({
    value: 'spline',    
    source: [
      {value: 'spline', text:'Spline'},
      {value: 'area', text:'Area'},
      {value: 'area-spline', text:'Area Spline'},
      {value: 'step', text:'Step'},
      {value: 'area-step', text:'Area Step'},
      {value: 'scatter', text:'Scatter'},
      {value: 'bar', text:'Bar'},
      {value: 'donut', text:'Donut'},
      {value: 'pie', text:'Pie'}
    ],
    success: function(response, newValue) {
      b.refresh({type: newValue});
    }
  });

  b = new builder();

  var pubnub3 = PUBNUB.init({
    subscribe_key: 'demo'
  });

  setInterval(function(){
    pubnub3.publish({
      channel: 'eon-builder',
      message: {
        something: 1,
        something_else: {
          another_thing: {
            value: Math.random() * 100
          }
        },
        a: Math.random() * 100,
        b: Math.random() * 100,
        c: Math.random() * 100,
      }
    });
  }, 1000);

  setInterval(function(){
    pubnub3.publish({
      channel: 'eon-builder22',
      message: {
        something: 1,
        something_else: {
          another_thing: {
            value: Math.random() * 100
          }
        },
        a: Math.random() * 100,
        b: Math.random() * 100,
        c: Math.random() * 100,
        a2: Math.random() * 100,
        b2: Math.random() * 100,
        c2: Math.random() * 100,
        a3: Math.random() * 100,
        b3: Math.random() * 100,
        c3: Math.random() * 100,
        a4: Math.random() * 100,
        b4: Math.random() * 100,
        c4: Math.random() * 100,
        a5: Math.random() * 100,
        b5: Math.random() * 100,
        c5: Math.random() * 100
      }
    });
  }, 1000)

  </script>

</body>
</html>