<!DOCTYPE html>
<html>
<head>
</head>
<body>
 
  <div class="container">
    <div class="row">
      <div class="col-md-12">

        <div id="chart"></div>

        <div class="form-group">
          <label>Subscribe Key</label>
          <input type="text" class="form-control" id="subscribe-key" value="sub-c-5f1b7c8e-fbee-11e3-aa40-02ee2ddab7fe">
        </div>

        <div class="form-group">
          <label>Channel</label>
          <input type="text" class="form-control" id="channel" value="pubnub-sensor-network">
        </div>

        <div class="form-group">
          <label>Chart Type</label>
          <select class="form-control" id="chart-type">
            <option value="spline">Spline</option>
            <option value="bar">Bar</option>
            <option value="donut">Donut</option>
          </select>
        </div>

        <label>Data</label>
        <div class="form-group">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Key</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody id="kvs">
          </tbody>
        </table>
        </div>

        <button type="submit" class="btn btn-default" id="submit">Submit</button>

      </div>
    </div>
  </div> 

  
  <script src="./bower_components/pubnub/web/pubnub.min.js"></script>
  <link rel="stylesheet" type="text/css" href="./bower_components/c3/c3.min.css">
  <script src="./bower_components/d3/d3.min.js"></script>
  <script src="./bower_components/c3/c3.min.js"></script>
  <script src="./bower_components/subsub/subsub.js"></script>

  <script type="text/javascript" src="./bower_components/jquery/dist/jquery.min.js"></script>
  <script type="text/javascript" src="./bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <link rel="stylesheet" type="text/css" href="./bower_components/bootstrap/dist/css/bootstrap.min.css">

  <script type="text/javascript" src="./bower_components/eon-chart/pubnub-c3.js"></script>

  <script type="text/javascript">

  var flattenObject = function(ob) {
    
    var toReturn = {};
    
    for (var i in ob) {
      if (!ob.hasOwnProperty(i)) continue;
      
      if ((typeof ob[i]) == 'object') {
        var flatObject = flattenObject(ob[i]);
        for (var x in flatObject) {
          if (!flatObject.hasOwnProperty(x)) continue;
          
          toReturn[i + '.' + x] = flatObject[x];
        }
      } else {
        toReturn[i] = ob[i];
      }
    }
    
    return toReturn;

  };

  var cols = [];
  var chart = null;
  var refresh = function function_name () {

    console.log('woot')

    var options = {
      type: $('#chart-type').val(),
      channel: $('#channel').val(),
      subscribe_key: $('#subscribe-key').val()
    }

    var pubnub = PUBNUB.init({
      subscribe_key: options.subscribe_key
    });

    var pedit = PUBNUB.init({
      subscribe_key: options.subscribe_key
    });

    var flow = false;
    if(options.type == "spline") {
      flow = true;
    }

    chart = eon.chart({
      pubnub: pubnub,
      channel: options.channel,
      history: true,
      flow: flow,
      generate: {
        bindto: '#chart',
        data: {
          type: options.type
        },
        bar: {
          width: {
            ratio: 0.5
          }
        }
      },
      transform: function(message) {

        var array = cols.map(function(arg){
          return [arg, message[arg]];
        });

        return {
          columns: array
        };

      }
    });

    pedit.subscribe({
      channel: options.channel,
      message: function(data) {

        var data = flattenObject(data);

        for(var key in data) {

          var $row = $('.key-'+key);

          var value = JSON.stringify(data[key]);

          if($row.length) {

            $row.find('.val').text(value)

          } else {

            var $row = $('\
              <tr class="key-' + key + '"> \
                <td class="key">' + key + '</td> \
                <td class="val">' + value + '</td> \
              </tr>');
           
            $row.click(function(){
              $(this).addClass('info');
              cols.push($(this).find('.key').text());
            });

            $('#kvs').append($row);

          }

        }

      }
    });

  }

  $('#chart-type').change(function(e) {
    refresh();
  });

  $('#submit').click(function(e) {
    refresh();
    return false;
  });

  refresh();

  </script>

</body>
</html>