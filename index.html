<!DOCTYPE html>
<html>
<head>
  <style type="text/css">
  #chart-wrapper {
    position: fixed;
  }
  #chart {
    height: 300px;
    width: 350px;
  }
  .container-fluid {
    width: 90%;
    margin-left: 5%;
    margin-right: 5%;
  }
  </style>
</head>
<body>
 
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-9">

        <div class="form-group">
          <label>Subscribe Key</label>
          <p class="text-muted">The PubNub subscribe key.</p>
          <input type="text" class="form-control" id="subscribe-key" value="demo">
        </div>

        <div class="form-group">
          <label>Channel</label>
          <p class="text-muted">The PubNub channel where your data is being published.</p>
          <input type="text" class="form-control" id="channel" value="eon-builder">
        </div>

        <label>Data</label>
        <p class="text-muted">Click on a row to start seeing it output to the chart. Note that only integer values are shown here.</p>

        <div class="form-group">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Key</th>
              <th>Value</th>
              <th>Color</th>
              <th>Graph</th>
            </tr>
          </thead>
          <tbody id="kvs">
          </tbody>
        </table>
        </div>

        <div class="form-group">
          <label>Chart Type</label>
          <p class="text-muted">Time series, bar, donut, your call.</p>
          <select class="form-control" id="chart-type">
            <option value="spline">Spline</option>
            <option value="area">Area</option>
            <option value="area-spline">Area Spline</option>
            <option value="step">Step</option>
            <option value="area-step">Area Step</option>
            <option value="scatter">Scatter</option>
            <option value="bar">Bar</option>
            <option value="donut">Donut</option>
            <option value="pie">Pie</option>
          </select>
        </div>

        <div class="form-group">
          <label>Update Rate (ms)</label>
          <p class="text-muted">How fast your chart will update. If data is published faster than the update rate, it will be overwritten. If the chart updates before new data is received, data will remain stagnant.</p>
          <input type="text" class="form-control" id="rate" value="1000">
        </div>

        <div class="form-group">
          <label>Animation (ms)</label>
          <p class="text-muted">How long each animation will last.</p>
          <input type="text" class="form-control" id="duration" value="250">
        </div>

        <div class="form-group">
          <label>Limit</label>
          <p class="text-muted">How many data points to display.</p>
          <input type="text" class="form-control" id="limit" value="5">
        </div>

        <div class="form-group">
          <input type="checkbox" id="history" checked>  <label>History</label>
          <p class="text-muted">Use PubNub history to populate the chart on load</p>
        </div>

      </div>
      <div class="col-md-3">
        <div id="chart-wrapper">
          <button type="submit" class="btn btn-default" id="submit">Update</button>
          <div id="chart"></div>
          <textarea id="embed" class="form-control" style="height: 500px"></textarea>
        </div>
      </div>
    </div>
  </div> 
  
  <script type="text/javascript" src="http://pubnub.github.io/eon/lib/eon.js"></script>
  <link type="text/css" rel="stylesheet" href="http://pubnub.github.io/eon/lib/eon.css" />

  <script type="text/javascript" src="./bower_components/jquery/dist/jquery.min.js"></script>
  <script type="text/javascript" src="./bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <link rel="stylesheet" type="text/css" href="./bower_components/bootstrap/dist/css/bootstrap.min.css">

  <link rel="stylesheet" type="text/css" href="./bower_components/mjolnic-bootstrap-colorpicker/dist/css/bootstrap-colorpicker.min.css">
  <script type="text/javascript" src="./bower_components/mjolnic-bootstrap-colorpicker/dist/js/bootstrap-colorpicker.min.js"></script>

  <link href="./bower_components/bootstrap-toggle/css/bootstrap-toggle.min.css" rel="stylesheet">
  <script src="./bower_components/bootstrap-toggle/js/bootstrap-toggle.min.js"></script>

  <script type="text/javascript">

  function isNumber(n) {
    return !isNaN(parseFloat(n)) && isFinite(n);
  }

  var chart = null;
  var cols = [];
  var colors = {};
  var refresh = function function_name () {

    var options = {
      type: $('#chart-type').val(),
      channel: $('#channel').val(),
      subscribe_key: $('#subscribe-key').val(),
      rate: $('#rate').val(),
      duration: $('#duration').val(),
      limit: $('#limit').val(),
      history: $('#history').is(':checked') || false
    }

    var pubnub = PUBNUB.init({
      subscribe_key: options.subscribe_key
    });

    var pedit = PUBNUB.init({
      subscribe_key: options.subscribe_key
    });

    var flow = false;
    if(options.type == "spline" ||
      options.type == "area" ||
      options.type == "area-spline" ||
      options.type == "step" ||
      options.type == "area-step" ||
      options.type == "scatter"
      ) {
      flow = true;
    }

    chart = eon.chart({
      pubnub: pubnub,
      channel: options.channel,
      history: true,
      flow: flow,
      rate: options.rate,
      limit: options.limit,
      generate: {
        bindto: '#chart',
        data: {
          type: options.type,
          colors: colors
        },
        transition: {
          duration: options.duration
        }
      },
      transform: function(message) {

        var message = eon.c.flatten(message);

        var array = cols.map(function(arg){
          return [arg, message[arg]];
        });

        return {
          columns: array
        };

      }
    });

    var genEmbed = function() {

      var embedsrc = '' +
        '<script type="text/javascript" src="http://pubnub.github.io/eon/lib/eon.js"><\/script>\n' +
        '<link type="text/css" rel="stylesheet" href="http://pubnub.github.io/eon/lib/eon.css" />\n' +
        '<div id="chart"></div>\n' + 
        '<script type="text/javascript">\n' +
        'var pubnub = PUBNUB.init({\n' +
        '  subscribe_key: "' + options.subscribe_key + '"\n' +
        '});\n' +
        'var cols = ' + '["' + cols.join('","') + '"];' + '\n' +
        'chart = eon.chart({\n' +
        '  pubnub: pubnub,\n' +
        '  channel: "' + options.channel + '",\n' +
        '  history: ' + options.history + ',\n' +
        '  flow: ' + flow +',\n' +
        '  rate: ' + options.rate + ',\n' +
        '  limit: ' + options.limit + ',\n' +
        '  generate: {\n' +
        '    bindto: "#chart",\n' +
        '    data: {\n' +
        '      type: "' + options.type + '"\n' +
        '    },\n' +
        '    transition: {\n' +
        '      duration: ' + options.duration + '\n' +
        '    },\n' +
        '  },\n' +
        '  transform: function(message) {\n' +
        '    var message = eon.c.flatten(message);\n' + 
        '    var array = cols.map(function(arg){\n' +
        '      return [arg, message[arg]];\n' +
        '    });\n' +
        '    return {\n' + 
        '      columns: array\n' +
        '    };\n' +
        '  }\n' + 
        '});\n' +
        '<\/script>';

      $('#embed').val(embedsrc)

    };
    genEmbed();
    
    pedit.subscribe({
      channel: options.channel,
      message: function(data) {

        var data = eon.c.flatten(data);

        for(var key in data) {

          var $row = $('[data-key="' + key + '"]');
          var value = data[key];

          if(!isNaN(value)) {

            if($row.length) {

              $row.find('.val').text(value)

            } else {

              cols.push(key);

              var $row = $('\
                <tr data-key="' + key + '"> \
                  <td class="key">' + key + '</td> \
                  <td class="val">' + value + '</td> \
                  <td> \
                    <div class="input-group colorpick" data-key="' + key + '"> \
                        <input type="text" value="" class="form-control" /> \
                        <span class="input-group-addon"><i></i></span> \
                    </div> \
                  </td> \
                  <td> \
                  <input type="checkbox" class="toggle" checked data-toggle="toggle"> \
                  </td> \
                </tr>');

              $row.find('.colorpick').colorpicker().on('changeColor.colorpicker', function(event){
                colors[$(this).closest('tr').attr('data-key')] = event.color.toHex();
                refresh();
              });

              $row.find('.toggle').bootstrapToggle('on');

              $row.find('.toggle').change(function() {

                console.log('called', $(this))
                
                var thisKey = $(this).closest('tr').attr('data-key');
                var isChecked = $(this).prop('checked');

                if(typeof (isChecked) !== "undefined") {

                  if(isChecked){

                    cols.push(thisKey);
                    genEmbed();

                  } else {

                    for(var i in cols) {

                      if(cols[i] == thisKey) {
                        cols.splice(i, 1);
                        refresh();
                      }

                    }
                     
                  }
                  console.log(isChecked)
                  console.log(cols)
                   
                }

              })

              $('#kvs').append($row);

            }

          }

        }

      }
    });

    $('#submit').click(function(e) {
      pedit.unsubscribe({
        channel: options.channel
      });
      pubnub.unsubscribe({
        channel: options.channel
      });
      $('#kvs').empty(); 
      refresh();
      cols = [];
      return false;
    });

    $('#chart-type').change(function(e) {
      refresh();
    });

  }



  var pubnub3 = PUBNUB.init({
    subscribe_key: 'demo'
  });

    setInterval(function(){
      pubnub3.publish({
        channel: 'eon-builder',
        message: {
          something: 1,
          something_else: {
            another_thing: {
              value: Math.random() * 100
            }
          }
        }
      });
    }, 250)

  refresh();

  </script>

</body>
</html>